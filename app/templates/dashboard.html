{% extends "base.html" %}
{% block content %}

<h2>Dashboard</h2>
<p>Welcome, {{ user.username }}!</p>

<div class="dashboard-columns">
  <!-- ================= LEFT: Your existing journal entries ================= -->
  <div class="dashboard-left">

    <!-- Filter form -->
    <form method="GET" action="{{ url_for('main.dashboard') }}" class="filter-form">

        <label for="q">Search:</label>
        <input type="text" id="q" name="q" placeholder="Search entries..." value="{{ request.args.get('q', '') }}">

        <label for="tag">Tag:</label>
        <input type="text" id="tag" name="tag" placeholder="e.g. Personal" value="{{ request.args.get('tag', '') }}">

        <label for="date">Date:</label>
        <input type="date" id="date" name="date" value="{{ request.args.get('date', '') }}">

        <button type="submit">Filter</button>
        <a href="{{ url_for('main.dashboard') }}" class="btn">Clear</a>
    </form>

    <h3>Your Log Entries</h3>

    <!-- Add new entry button -->
    <div style="margin-bottom: 25px; margin-left: 325px;">
        <a href="{{ url_for('main.add_entry')}}" class="btn"> + Add New Entry</a>
    </div>

    {% if entries.items %}
        <!-- Container where entries get loaded; JS will append more here -->
        <div id="entries-container" class="entry-list" data-total-pages="{{ entries.pages }}">
            {% include "partials/entries_list.html" %}
        </div>

        <!-- Loader shown during fetch -->
        <div id="loading" style="display:none; text-align:center; margin:20px;">
            <p>Loading more entries...</p>
        </div>

    {% else %}
        <p>You have no entries yet. </p>
    {% endif %}

  </div>

  <!-- ================= RIGHT: Calendar with goals ================= -->
  <div class="dashboard-right">
    <h3>Goal Deadlines</h3>
    <div id="calendar"></div>
    {% if not goals %}
      <p style="margin-top:10px; color:gray;">No goals yet. Add one to see it here.</p>
    {% endif %}
  </div>
</div>

<!-- Keep your existing JS for journal entries -->
<script>
window.addEventListener("DOMContentLoaded", function () {
    const entryContainer = document.getElementById("entries-container");
    if (!entryContainer) return;

    const loader = document.getElementById("loading");
    let currentPage = 1;
    let loading = false;
    const totalPages = Number(entryContainer.dataset.totalPages || 1);
    const entriesPartialUrl = "{{ url_for('main.entries_partial') }}";

    async function loadMoreEntries() {
        if (loading) return;
        if (currentPage >= totalPages) return;

        loading = true;
        loader.style.display = "block";
        currentPage++;

        try {
            const response = await fetch(
                `${entriesPartialUrl}?page=${currentPage}&tag={{ request.args.get('tag', '') }}&date={{ request.args.get('date', '') }}`
            );

            if (response.ok) {
                const html = await response.text();
                await new Promise(resolve => setTimeout(resolve, 1000)); // delay for loader

                if (html.trim() !== "") {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    tempDiv.querySelectorAll('.entry-card').forEach(card => card.classList.add('new-entry'));
                    while (tempDiv.firstChild) entryContainer.appendChild(tempDiv.firstChild);
                    entryContainer.querySelectorAll('.new-entry').forEach(card => {
                        requestAnimationFrame(() => card.classList.remove('new-entry'));
                    });
                } else {
                    window.removeEventListener("scroll", handleScroll);
                }
            }
        } catch (err) {
            console.error("Error loading entries:", err);
        } finally {
            loader.style.display = "none";
            loading = false;
        }
    }

    function handleScroll() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
            loadMoreEntries();
        }
    }

    window.addEventListener("scroll", handleScroll);
});
</script>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    // Convert Flask goals to FullCalendar events
    const goals = [
        {% for g in goals %}
        {
            name: "{{ g.name }}",
            deadline: "{{ g.deadline.isoformat() if g.deadline else '' }}",
            priority: "{{ g.priority }}",
            color: "{{ g.color or '' }}",
            url: "{{ url_for('main.list_goals', goal_id=g.id) }}"
        },
        {% endfor %}
    ];

    const events = goals.map(goal => ({
        title: goal.name,                   // text shown in the calendar rectangle
        start: goal.deadline,               // deadline date
        color: goal.color || (goal.priority === 'High' ? '#dc3545' : '#28a745'), // red for high, green for others
        url: goal.url || '',                // optional: link if clicking event should go somewhere
    }));

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',          // auto height to fit screen better
        events: events,
        eventClick: function(info) {
            if (info.event.url) {
                window.open(info.event.url, "_blank"); // open linked goal in new tab
                info.jsEvent.preventDefault();
            }
        },
        eventDisplay: 'block',   // ensures full text shows
        dayMaxEventRows: true,   // show "more" if too many events
        editable: false,
        selectable: false,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        eventDidMount: function(info) {
            // Add tooltip showing goal name
            info.el.setAttribute('title', info.event.title);
        }
    });

    calendar.render();
});
</script>


<style>
.dashboard-columns {
  display: flex;
  gap: 20px;
  margin-top: 20px;
}
.dashboard-left {
  flex: 2;
  min-width: 0;
}
.dashboard-right {
  flex: 1;
  min-width: 300px;
  max-width: 500px;
}
@media (max-width: 900px) {
  .dashboard-columns {
    flex-direction: column;
  }
  .dashboard-right {
    max-width: 100%;
  }
}
</style>

{% endblock %}
