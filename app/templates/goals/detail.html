{% extends "base.html" %}

{% block content %}
<h2>{{ goal.name }}</h2>
<p>
  <strong>Start:</strong> {{ goal.start_value if goal.start_value is not none else "N/A" }} {{ goal.unit or "" }}<br>
  <strong>Target:</strong> {{ goal.target_value if goal.target_value is not none else "N/A" }} {{ goal.unit or "" }}<br>
  <strong>Deadline:</strong> {{ goal.deadline.strftime("%Y-%m-%d") if goal.deadline else "No deadline" }}
</p>
{% if eta %}
<p>Estimated completion date: <strong>{{ eta }}</strong></p>
{% endif %}

{% if values|length > 0 %}
<div style="margin: 20px 0;">
  <canvas id="goalChart" style="max-width: 900px; width: 100%; height: 360px;"></canvas>
</div>

<!-- Stats Overview -->
<div id="statsOverview" style="
  margin: 20px 0;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #f9fafb;
  max-width: 900px;
">
  <h3 style="margin-bottom: 10px; color: #111827;">ðŸ“Š Stats Overview</h3>
  <ul id="statsList" style="list-style: none; padding: 0; margin: 0; line-height: 1.6;"></ul>
</div>
{% else %}
<p>No numeric progress yet. Only images/notes will appear.</p>
{% endif %}

<div style="display:flex; gap:10px; flex-wrap:wrap;">
  <a href="{{ url_for('main.add_goal_progress', goal_id=goal.id) }}" class="btn">âž• Add Progress</a>
  <a href="{{ url_for('main.list_goals') }}" class="btn" style="background:#6c757d;">â¬… Back to Goals</a>
  <form method="POST" action="{{ url_for('main.delete_goal', goal_id=goal.id) }}"
        onsubmit="return confirm('Are you sure you want to delete this goal?');">
      <button type="submit" class="btn delete-btn">Delete Goal</button>
  </form>
</div>

<!-- Progress notes & images -->
<h3 style="margin-top: 30px;">Progress Updates</h3>
{% if progress_entries %}
  <ul style="list-style:none; padding:0;">
    {% for p in progress_entries %}
      <li style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
        <strong>{{ p.date.strftime("%Y-%m-%d") }}</strong>
        {% if p.value is not none %}<br>Value: {{ p.value }} {{ goal.unit or "" }}{% endif %}
        {% if p.note %}<br>Note: {{ p.note }}{% endif %}
        {% if p.image %}
          <div style="margin-top:8px;">
            <img src="{{ url_for('static', filename='progress_images/' ~ p.image) }}"
                 alt="Progress image" style="max-width:250px; border-radius:6px;">
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No progress updates yet.</p>
{% endif %}

{% if values|length > 0 %}
<!-- Embed chart data -->
<script id="goal-data" type="application/json">
{
  "dates": {{ dates|tojson }},
  "values": {{ values|tojson }},
  "unit": "{{ goal.unit or '' }}",
  "target": {{ goal.target_value if goal.target_value is not none else 'null' }}
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
(function() {
  const goalData = JSON.parse(document.getElementById('goal-data').textContent);

  // convert YYYY-MM-DD string â†’ UTC midnight timestamp
  function toUtcMs(dateStr) {
    const [y,m,d] = dateStr.split('-').map(Number);
    return Date.UTC(y, m-1, d);
  }

  // build series with +1 day offset so x-axis labels match points
  let series = goalData.dates.map((d, i) => {
    const v = goalData.values[i];
    if (v === null || v === undefined) return null;
    return { x: toUtcMs(d) + 24*60*60*1000, y: Number(v), date: d }; // keep date for stats
  }).filter(Boolean);

  // sort ascending
  series.sort((a, b) => a.x - b.x);

  // Target line using same adjusted timestamps
  let targetSeries = [];
  if (goalData.target !== null) {
    targetSeries = [
      { x: series[0].x, y: Number(goalData.target) },
      { x: series[series.length-1].x, y: Number(goalData.target) }
    ];
  }

  const ctx = document.getElementById('goalChart').getContext('2d');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Progress',
          data: series,
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79, 70, 229, 0.1)',
          tension: 0.3,
          fill: false, 
          pointRadius: 5,
          pointHoverRadius: 8,
          pointBackgroundColor: '#4f46e5',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        },
        {
          label: 'Target',
          data: targetSeries,
          borderColor: '#ef4444',
          borderDash: [6, 6],
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.y + ' ' + goalData.unit;
            }
          }
        },
        legend: {
          labels: {
            font: {
              size: 16, weight: 'bold', color: '#111827'
            }
          }
        },
        title: {
          display: true,
          text: 'Goal Progress Over Time',
          font: { size: 18, weight: 'bold' },
          color: '#111827',
          padding: { top: 10, bottom: 20 }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
          min: series[0].x,
          max: series[series.length-1].x,
          offset: true,
          ticks: { source: 'data', size: 16, weight: 'bold', color: '#111827' },
          title: { display: true, text: 'Date', font: {size: 16, weight: 'bold', color: '#111827'} }
        },
        y: {
          grid: { color: 'rgba(0,0,0,0.05)' },
          ticks: { font: { size: 16, weight: 'bold', color: '#111827' } },
          title: { display: true, text: goalData.unit || 'Value', font: { size: 16, weight: 'bold'}, color: '#111827' }
        }
      }
    }
  });

  // ==== Stats Overview ====
  const startVal = series[0].y;
  const latestVal = series[series.length-1].y;
  const changeAbs = latestVal - startVal;
  const changePct = ((changeAbs / startVal) * 100).toFixed(1);
  const targetDiff = goalData.target !== null ? (latestVal - goalData.target) : null;
  const best = series.reduce((min, p) => p.y < min.y ? p : min, series[0]);
  const worst = series.reduce((max, p) => p.y > max.y ? p : max, series[0]);

  function formatDelta(val, unit) {
    const color = val < 0 ? 'green' : (val > 0 ? 'red' : 'black');
    const sign = val > 0 ? '+' : '';
    return `<span style="color:${color}; font-weight:bold;">${sign}${val} ${unit}</span>`;
  }

  const statsList = document.getElementById('statsList');
  if (statsList) {
    statsList.innerHTML = `
      <li><strong>Start Value:</strong> ${startVal} ${goalData.unit || ''}</li>
      <li><strong>Latest Value:</strong> ${latestVal} ${goalData.unit || ''}</li>
      <li><strong>Change Since Start:</strong> ${formatDelta(changeAbs, goalData.unit || '')} (${changePct}%)</li>
      ${goalData.target !== null ? `<li><strong>To Target:</strong> ${formatDelta(targetDiff, goalData.unit || '')}</li>` : ''}
      <li><strong>Total Entries:</strong> ${series.length}</li>
      <li><strong>Best Day:</strong> ${best.date} (${best.y} ${goalData.unit || ''})</li>
      <li><strong>Worst Day:</strong> ${worst.date} (${worst.y} ${goalData.unit || ''})</li>
    `;
  }

})();
</script>
{% endif %}
{% endblock %}
